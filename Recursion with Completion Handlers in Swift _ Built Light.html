<!DOCTYPE html>
<!-- saved from url=(0086)https://builtlight-staging.herokuapp.com/activity/recursion-completion-handlers-swift/ -->
<html class="wf-museosans-n3-active wf-sourcecodepro-n7-active wf-museoslab-n3-active wf-museoslab-n5-active wf-sourcecodepro-i4-active wf-museosansrounded-n5-active wf-lato-i4-active wf-lato-i7-active wf-lato-n7-active wf-lato-n4-active wf-museoslab-n7-active wf-sourcecodepro-n4-active wf-museosans-n5-active wf-museosans-i5-active wf-museoslab-i3-active wf-museoslab-i5-active wf-museoslab-n8-active wf-active"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        
        
        
        <meta content="initial-scale=1.0" name="viewport">
        
        <meta name="description" content="">
        
        
            
        
        
        <title>
            
                Recursion with Completion Handlers in Swift
            
             | Built Light
        </title>
        
        
        <link rel="stylesheet" type="text/css" href="./Recursion with Completion Handlers in Swift _ Built Light_files/builtlight.4fd7a6c83758.css">

        
    <link rel="stylesheet" type="text/css" href="./Recursion with Completion Handlers in Swift _ Built Light_files/activity.f24f17bc5f53.css">
    <link rel="stylesheet" type="text/css" href="./Recursion with Completion Handlers in Swift _ Built Light_files/swiper.min.96b66e4018ab.css">
    <link rel="stylesheet" type="text/css" href="./Recursion with Completion Handlers in Swift _ Built Light_files/pygments.82dd9ef8e8b3.css">
    <link rel="stylesheet" type="text/css" href="./Recursion with Completion Handlers in Swift _ Built Light_files/portfolio.1b2efa2e9d92.css">


        
        <script src="./Recursion with Completion Handlers in Swift _ Built Light_files/jquery.min.js"></script>

        
        <script src="./Recursion with Completion Handlers in Swift _ Built Light_files/vqw1xxh.js"></script>
        <style type="text/css">.tk-lato{font-family:"lato",sans-serif;}</style><style type="text/css">@font-face{font-family:museo-sans;src:url(https://use.typekit.net/af/620bf8/00000000000000000000e7fe/27/l?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n3&v=3) format("woff2"),url(https://use.typekit.net/af/620bf8/00000000000000000000e7fe/27/d?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n3&v=3) format("woff"),url(https://use.typekit.net/af/620bf8/00000000000000000000e7fe/27/a?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n3&v=3) format("opentype");font-weight:300;font-style:normal;font-stretch:normal;font-display:auto;}@font-face{font-family:museo-sans;src:url(https://use.typekit.net/af/a28b50/00000000000000000000e803/27/l?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n5&v=3) format("woff2"),url(https://use.typekit.net/af/a28b50/00000000000000000000e803/27/d?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n5&v=3) format("woff"),url(https://use.typekit.net/af/a28b50/00000000000000000000e803/27/a?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n5&v=3) format("opentype");font-weight:500;font-style:normal;font-stretch:normal;font-display:auto;}@font-face{font-family:museo-sans;src:url(https://use.typekit.net/af/c2d3de/00000000000000000000e804/27/l?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=i5&v=3) format("woff2"),url(https://use.typekit.net/af/c2d3de/00000000000000000000e804/27/d?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=i5&v=3) format("woff"),url(https://use.typekit.net/af/c2d3de/00000000000000000000e804/27/a?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=i5&v=3) format("opentype");font-weight:500;font-style:italic;font-stretch:normal;font-display:auto;}@font-face{font-family:museo-slab;src:url(https://use.typekit.net/af/53dec0/0000000000000000000100fe/27/l?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n3&v=3) format("woff2"),url(https://use.typekit.net/af/53dec0/0000000000000000000100fe/27/d?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n3&v=3) format("woff"),url(https://use.typekit.net/af/53dec0/0000000000000000000100fe/27/a?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n3&v=3) format("opentype");font-weight:300;font-style:normal;font-stretch:normal;font-display:auto;}@font-face{font-family:museo-slab;src:url(https://use.typekit.net/af/ea0e14/000000000000000000010141/27/l?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=i3&v=3) format("woff2"),url(https://use.typekit.net/af/ea0e14/000000000000000000010141/27/d?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=i3&v=3) format("woff"),url(https://use.typekit.net/af/ea0e14/000000000000000000010141/27/a?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=i3&v=3) format("opentype");font-weight:300;font-style:italic;font-stretch:normal;font-display:auto;}@font-face{font-family:museo-slab;src:url(https://use.typekit.net/af/aa4f4e/000000000000000000012043/27/l?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n5&v=3) format("woff2"),url(https://use.typekit.net/af/aa4f4e/000000000000000000012043/27/d?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n5&v=3) format("woff"),url(https://use.typekit.net/af/aa4f4e/000000000000000000012043/27/a?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n5&v=3) format("opentype");font-weight:500;font-style:normal;font-stretch:normal;font-display:auto;}@font-face{font-family:museo-slab;src:url(https://use.typekit.net/af/f1892e/00000000000000000000ec08/27/l?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=i5&v=3) format("woff2"),url(https://use.typekit.net/af/f1892e/00000000000000000000ec08/27/d?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=i5&v=3) format("woff"),url(https://use.typekit.net/af/f1892e/00000000000000000000ec08/27/a?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=i5&v=3) format("opentype");font-weight:500;font-style:italic;font-stretch:normal;font-display:auto;}@font-face{font-family:museo-slab;src:url(https://use.typekit.net/af/c225e2/000000000000000000011aff/27/l?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n7&v=3) format("woff2"),url(https://use.typekit.net/af/c225e2/000000000000000000011aff/27/d?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n7&v=3) format("woff"),url(https://use.typekit.net/af/c225e2/000000000000000000011aff/27/a?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n7&v=3) format("opentype");font-weight:700;font-style:normal;font-stretch:normal;font-display:auto;}@font-face{font-family:museo-slab;src:url(https://use.typekit.net/af/a09522/00000000000000000000ec0b/27/l?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n8&v=3) format("woff2"),url(https://use.typekit.net/af/a09522/00000000000000000000ec0b/27/d?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n8&v=3) format("woff"),url(https://use.typekit.net/af/a09522/00000000000000000000ec0b/27/a?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n8&v=3) format("opentype");font-weight:800;font-style:normal;font-stretch:normal;font-display:auto;}@font-face{font-family:museo-sans-rounded;src:url(https://use.typekit.net/af/a03e49/00000000000000003b9b1e2e/27/l?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n5&v=3) format("woff2"),url(https://use.typekit.net/af/a03e49/00000000000000003b9b1e2e/27/d?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n5&v=3) format("woff"),url(https://use.typekit.net/af/a03e49/00000000000000003b9b1e2e/27/a?primer=c1627fd7b7efc3ea862ea124732198613672ed60d7d14b8606daecd7d2df956d&fvd=n5&v=3) format("opentype");font-weight:500;font-style:normal;font-stretch:normal;font-display:auto;}@font-face{font-family:lato;src:url(https://use.typekit.net/af/bdde80/00000000000000000001522d/27/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i4&v=3) format("woff2"),url(https://use.typekit.net/af/bdde80/00000000000000000001522d/27/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i4&v=3) format("woff"),url(https://use.typekit.net/af/bdde80/00000000000000000001522d/27/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i4&v=3) format("opentype");font-weight:400;font-style:italic;font-stretch:normal;font-display:auto;}@font-face{font-family:lato;src:url(https://use.typekit.net/af/6c7e72/000000000000000000015232/27/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i7&v=3) format("woff2"),url(https://use.typekit.net/af/6c7e72/000000000000000000015232/27/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i7&v=3) format("woff"),url(https://use.typekit.net/af/6c7e72/000000000000000000015232/27/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i7&v=3) format("opentype");font-weight:700;font-style:italic;font-stretch:normal;font-display:auto;}@font-face{font-family:lato;src:url(https://use.typekit.net/af/220823/000000000000000000015231/27/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n7&v=3) format("woff2"),url(https://use.typekit.net/af/220823/000000000000000000015231/27/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n7&v=3) format("woff"),url(https://use.typekit.net/af/220823/000000000000000000015231/27/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n7&v=3) format("opentype");font-weight:700;font-style:normal;font-stretch:normal;font-display:auto;}@font-face{font-family:lato;src:url(https://use.typekit.net/af/180254/00000000000000000001522c/27/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n4&v=3) format("woff2"),url(https://use.typekit.net/af/180254/00000000000000000001522c/27/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n4&v=3) format("woff"),url(https://use.typekit.net/af/180254/00000000000000000001522c/27/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n4&v=3) format("opentype");font-weight:400;font-style:normal;font-stretch:normal;font-display:auto;}@font-face{font-family:source-code-pro;src:url(https://use.typekit.net/af/756772/0000000000000000000179d5/27/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n7&v=3) format("woff2"),url(https://use.typekit.net/af/756772/0000000000000000000179d5/27/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n7&v=3) format("woff"),url(https://use.typekit.net/af/756772/0000000000000000000179d5/27/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n7&v=3) format("opentype");font-weight:700;font-style:normal;font-stretch:normal;font-display:auto;}@font-face{font-family:source-code-pro;src:url(https://use.typekit.net/af/3c21b3/0000000000000000000179cf/27/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n4&v=3) format("woff2"),url(https://use.typekit.net/af/3c21b3/0000000000000000000179cf/27/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n4&v=3) format("woff"),url(https://use.typekit.net/af/3c21b3/0000000000000000000179cf/27/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=n4&v=3) format("opentype");font-weight:400;font-style:normal;font-stretch:normal;font-display:auto;}@font-face{font-family:source-code-pro;src:url(https://use.typekit.net/af/d090fb/0000000000000000000179d0/27/l?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i4&v=3) format("woff2"),url(https://use.typekit.net/af/d090fb/0000000000000000000179d0/27/d?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i4&v=3) format("woff"),url(https://use.typekit.net/af/d090fb/0000000000000000000179d0/27/a?primer=7cdcb44be4a7db8877ffa5c0007b8dd865b3bbc383831fe2ea177f62257a9191&fvd=i4&v=3) format("opentype");font-weight:400;font-style:italic;font-stretch:normal;font-display:auto;}</style><script>try{Typekit.load({ async: false });}catch(e){}</script>        
         
         
		<script type="text/javascript" src="./Recursion with Completion Handlers in Swift _ Built Light_files/main-column-fix.7ac59d9fb385.js"></script>      
         
        
    <script type="text/javascript" src="./Recursion with Completion Handlers in Swift _ Built Light_files/swiper.min.d6db96137503.js"></script>

        
    </head>

    <body class="activity">
        

        <header id="site-header">
            <a class="logo" href="https://builtlight-staging.herokuapp.com/"></a>
            <a href="mailto:info@builtlight.org">info@builtlight.org</a>
            <a class="twitter" href="https://www.twitter.com/BuiltLight" target="_blank">@builtlight</a>
        </header>
            
        <nav id="site-nav" class="no-portfolio">
            <a id="home" href="https://builtlight-staging.herokuapp.com/">focus</a>
            <img class="slash" src="./Recursion with Completion Handlers in Swift _ Built Light_files/slash-double.540161e5f21b.png" height="14" width="34">
            <a id="activity" href="https://builtlight-staging.herokuapp.com/activity">activity</a>
            <img class="slash" src="./Recursion with Completion Handlers in Swift _ Built Light_files/slash-double.540161e5f21b.png" height="14" width="34">
            <a id="process" href="https://builtlight-staging.herokuapp.com/process">process</a> 
            <img class="slash" src="./Recursion with Completion Handlers in Swift _ Built Light_files/slash-double.540161e5f21b.png" height="14" width="34">
            <a id="us" href="https://builtlight-staging.herokuapp.com/us">us</a>
            <img class="slash" src="./Recursion with Completion Handlers in Swift _ Built Light_files/slash-double.540161e5f21b.png" height="14" width="34">
            <a id="work" href="https://builtlight-staging.herokuapp.com/work">work</a>
            
        </nav>

		<main>
        

    <article class="activity-post">
        <header>
            <time datetime="2016-11-24">Th | 11 | 24 | 16</time>
            <h1>
                
                    Recursion with Completion Handlers in Swift
                
            </h1>
        </header>
        
        
            <div class="rich-text"><p>We recently shipped Simple HDR, an app that controls the &lt;a href="https://theta360.com/en/"&gt;Ricoh Theta&lt;/a&gt; 360° camera. The app's key feature is the ability to capture a sequence of images with varying shutter speeds, which can then be used to create an &lt;a href="https://en.wikipedia.org/wiki/High-dynamic-range_imaging" target="_blank"&gt;HDR&lt;/a&gt; (high dynamic range) image. In the process of building this feature, we arrived at an interesting solution that relies on recursion.</p><p><br></p><p>As you may know, &lt;a href="https://en.wikipedia.org/wiki/Recursion_(computer_science)" target="_blank"&gt;recursion&lt;/a&gt; is the staple of iteration in &lt;a href="https://en.wikipedia.org/wiki/Functional_programming" target="_blank"&gt;functional programming languages&lt;/a&gt;, and can often be an elegant solution to problems otherwise addressed using messy looping constructs. “Elegant” here meaning, short, simple and, most importantly, easiest for your future self (who no longer has any recollection of the program logic) to figure out.</p><p><br></p><p>&lt;a href="https://developer.apple.com/swift/" target="_blank"&gt;Swift&lt;/a&gt;, being a functional language, is well suited to recursion. However, since we need to solving real world problems involving networking, persistence, etc., completion handlers are a fact of life. These add an interesting twist to the application of recursion since such closures can't return anything and values must be "returned" by passing them into the provided handler.</p><p><br></p><p>How can we do recursion without return values?</p><p><br></p><p>We'll get to that, but first, a refresher: the “Hello World!” of recursion is the calculation of &lt;a href="https://en.wikipedia.org/wiki/Factorial" target="_blank"&gt;N!, or N factorial&lt;/a&gt;, defined as N! = N*(N-1)*(N-2)*...1. For example, the factorial of 4 is 4*3*2*1, which gives us a result of 24.</p><p><br></p><p>One possible swift implementation is:</p><p>&lt;pre class="lang:swift decode:true"&gt; func factorial(N:Int) -&amp;gt; Int {</p><p>&nbsp; &nbsp; if N == 1 {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return 1</p><p>&nbsp; &nbsp; } else {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return factorial((N-1)*N) // doing the multiplications here (in the returns)</p><p>&nbsp; &nbsp; }</p><p>}&lt;/pre&gt;</p><p>On each iteration, N is reduced by one and passed to the next call of factorial(). When N becomes 1, the function calls return and 1*…(N-1)*N is computed as execution returns to the scope of the initial call.</p><p><br></p><p>In recursion you have two options as to where the "work" (e.g. computation, networking, database access...) gets done. In the recursive implementation of factorial given above, the work(multiplications) are performed as execution returns back up the function call stack. The result accumulates in the return values and is available when control reaches the initial call to factorial().</p><p><br></p><p>You can also do your work on the way down(&lt;a href="http://stackoverflow.com/questions/33923/what-is-tail-recursion" target="_blank"&gt;tail recursion&lt;/a&gt;) so that it is completed when execution arrives at the recursive base case at the bottom of the call stack. In the case of factorial, this requires an additional argument where the result accumulates since we're not using the return values for this purpose.</p><p><br></p><p>A "work done on the way down"(tail-recursive) solution is:</p><p>&lt;pre class="lang:swift decode:true "&gt;func factorial(N:Int, oldTotal:Int) -&amp;gt; Int {</p><p>&nbsp; &nbsp; if N == 1 {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return oldTotal // factorial has been computed</p><p>&nbsp; &nbsp; } else {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; let newTotal = oldTotal * N // doing multiplications here (before the returns)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; return factorial(N-1, oldTotal:newTotal)</p><p>&nbsp; &nbsp; }</p><p>}&lt;/pre&gt;</p><p>The second argument complicates the function profile and the initial call must pass 1 (you could create a wrapper to keep your API pretty), but may be slightly more comprehensible for those new to recursion.</p><p><br></p><p>If performance is an issue, an additional benefit of tail-recursion is that it can be more easily optimized by a compiler.</p><p><br></p><p>Back to the camera: for the sake of simplicity let's say the picture taking function is the following:</p><p>&lt;pre class="lang:swift decode:true"&gt;takePicture(shutterSpeed:Double, completionHandler:() -&amp;gt; ())</p><p>&lt;/pre&gt;</p><p>Taking the picture and storing it is actually a side-effect, not very functional, but that's the reality of the hardware.</p><p><br></p><p>The camera only accepts a request to take a new picture after the current picture taking process is complete, so kicking off all the requests in parallel and coordinating the results with &nbsp;&lt;a href="https://developer.apple.com/library/ios/documentation/Performance/Reference/GCD_libdispatch_Ref/" target="_blank"&gt;Grand Central Dispatch&lt;/a&gt; (GCD) dispatch groups is not an option.</p><p><br></p><p>For a small, fixed number of pictures, the requests can simply be nested:</p><p>&lt;pre class="lang:swift decode:true "&gt;takePicture(shutterSpeeds[0], {</p><p>&nbsp; &nbsp; takePicture(shutterSpeeds[1], {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; takePicture(shutterSpeeds[2], {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print("We’ve taken 3 pictures.")</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; }</p><p>}&lt;/pre&gt;</p><p>But for an arbitrary number of pictures, where that number might be large, the iterative solution is an ugly looping system with &lt;a href="https://en.wikipedia.org/wiki/Semaphore_(programming)" target="_blank"&gt;semaphores&lt;/a&gt; so that the loop waits until the handler for the last call to takePicture() executes. Note:since the handlers can come back at any time, on any thread, a simple flag won't do.</p><p><br></p><p>Something like:</p><p>&lt;pre class="lang:swift decode:true "&gt;for speed in shutterSpeeds {</p><p>&nbsp; &nbsp; dispatch_semaphore_t wait_sema = dispatch_semaphore_create(0)</p><p>&nbsp; &nbsp; takePicture(speed, {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; print("Done taking a picture.")</p><p>&nbsp; &nbsp; &nbsp; &nbsp; dispatch_semaphore(wait_sema) // safe to call takPicture() again</p><p>&nbsp; &nbsp; }</p><p>&nbsp; &nbsp; while(dispatch_semaphore_wait(wait_sema), DISPATCH_TIME_NOW)) {</p><p>&nbsp; &nbsp; &nbsp; // wait until the previous handler executes</p><p>&nbsp; &nbsp; &nbsp; NSRunLoop.currentRunLoop.runUntilDate(NSDate.dateWithTimeIntervalSinceNow(0))</p><p>&nbsp; &nbsp; }</p><p>}&lt;/pre&gt;</p><p>I like GCD, but I try to avoid the additional complexity of semaphores whenever possible. Can we somehow get the simplicity of nesting, but for an arbitrary number of pictures?</p><p><br></p><p>We can, by using recursion.</p><p><br></p><p>As a way to start thinking about solving our camera problem using recursion, we'll look at how we might compute factorial so that the result is returned in a completion handler.</p><p><br></p><p>The complication is that the final result will need to be passed IN to the handler, rather than simply returned.</p><p>The most straightforward method is to do the computation "on the way down" by passing the closure, "as is", down to the base case where it receives the computed factorial as it's argument:</p><p>&lt;pre class="lang:swift decode:true"&gt;func closureFactorial(N:Int, tempResult:Int, completionHandler:(result:Int) -&amp;gt; ()) {</p><p>&nbsp; &nbsp; if N == 1 {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; completionHandler(result: tempResult) // factorial computed</p><p>&nbsp; &nbsp; } else {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; closureFactorial(N-1, tempResult:N*tempResult, completionHandler:completionHandler)</p><p>&nbsp; &nbsp; }</p><p>}&lt;/pre&gt;</p><p>Since we're doing our multiplications "on the way down", we'll need an additional argument for storing the result.</p><p><br></p><p>Is there a way of using backward recursion so we avoid the extra argument?</p><p><br></p><p>Backward recursion with completion handlers works somewhat differently:</p><p>&lt;pre class="lang:swift decode:true "&gt;func closureFactorial(N:Int, completionHandler:(result:Int) -&amp;gt; ()) {</p><p>&nbsp; &nbsp; if N == 1 {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; completionHandler(result:1)&nbsp;</p><p>&nbsp; &nbsp; } else {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; // add another wrapper to the closure</p><p>&nbsp; &nbsp; &nbsp; &nbsp; closureFactorial(N-1) { (result) -&amp;gt; () in</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; let newResult = result*N</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; completionHandler(result:newResult) // passed closure is wrapped</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; }</p><p>}&lt;/pre&gt;</p><p>Rather than just passing the handler down to the base case, a handler that computes the complete solution is built by accretion as each recursive call is made. Like an oyster wrapping a pearl, each call to factorial wraps the handler it is passed, then passes that wrapping handler to the next call. Only when execution reaches the base case is the final accreted closure executed.</p><p><br></p><p>Returning to our camera example, and applying handler recursion, we get:</p><p>&lt;pre class="lang:swift decode:true "&gt;func takePictureSequence(shutterSpeeds:[Double], completionHandler:() -&amp;gt; ()){</p><p>&nbsp; &nbsp; if shutterSpeeds.count == 0 { // The base case</p><p>&nbsp; &nbsp; &nbsp; &nbsp; completionHandler()</p><p>&nbsp; &nbsp; } else {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; let speed = shutterSpeeds[0]</p><p>&nbsp; &nbsp; &nbsp; &nbsp; let newSpeeds = Array(shutterSpeeds[1..&amp;lt;shutterSpeeds.count])</p><p>&nbsp; &nbsp; &nbsp; &nbsp; takePicture(speed) {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; takePictureSequence(newSpeeds, completionHandler:completionHandler)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; } &nbsp;&nbsp;</p><p>&nbsp; &nbsp; } &nbsp;&nbsp;</p><p>}&lt;/pre&gt;</p><p>The recursive solution is much nicer and requires no help from GCD:</p><p><br></p><p>As it happens, there's no need to pass anything back in the handler (the pictures are simply saved as they're taken) so we applied the forward style. If there were something to return (like file handles for the images), we could just as easily have applied the backward style in order to avoid the additional argument.</p><p><br></p><p>Assuming takePicture is now:</p><p>&lt;pre class="lang:swift decode:true "&gt;takePicture(shutterSpeed:Double, completionHandler:(fileHandle:Int) -&amp;gt; ())</p><p>&lt;/pre&gt;</p><p>A backward recursion solution would be:</p><p>&lt;pre class="lang:swift decode:true "&gt;func takePictureSequence(shutterSpeeds:[Double], completionHandler:(fileHandles:[Int]) -&amp;gt; ()){</p><p>&nbsp; &nbsp; if shutterSpeeds.count == 0 { // base case</p><p>&nbsp; &nbsp; &nbsp; &nbsp; completionHandler(fileHandles:[])</p><p>&nbsp; &nbsp; } else {</p><p>&nbsp; &nbsp; &nbsp; &nbsp; let speed = shutterSpeeds[0]</p><p>&nbsp; &nbsp; &nbsp; &nbsp; let newSpeeds = Array(shutterSpeeds[1..&amp;lt;shutterSpeeds.count])</p><p>&nbsp; &nbsp; &nbsp; &nbsp; takePictureSequence(newSpeeds) { (fileHandles) -&amp;gt; () in</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; takePicture(speed) { (fileHandle) -&amp;gt; () in</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; let newHandles = fileHandles + [fileHandle]</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; completionHandler(fileHandles:newHandles)</p><p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; &nbsp; &nbsp; }</p><p>&nbsp; &nbsp; }</p><p>}&lt;/pre&gt;</p><p>&lt;a href="https://en.wikipedia.org/wiki/Recursion_(computer_science)" target="_blank"&gt;Recursion&lt;/a&gt; is a powerful technique that is made a little bit more hairy by completion handlers. Hopefully, this has been a helpful explanation of how the technique can be used in conjunction with completion handlers in Swift.</p></div>
        
            <div class="pygments"><pre><span></span><span class="kd">func</span> <span class="nf">pauseAnimation</span><span class="p">()</span> <span class="p">{</span>

    <span class="k">guard</span> <span class="n">animationState</span> <span class="p">==</span> <span class="p">.</span><span class="n">Animating</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="p">}</span>
    <span class="n">animationState</span> <span class="p">=</span> <span class="p">.</span><span class="n">Paused</span>
    
    <span class="kd">let</span> <span class="nv">pausedTime</span> <span class="p">=</span> <span class="n">layer</span><span class="p">.</span><span class="n">convertTime</span><span class="p">(</span><span class="n">CACurrentMediaTime</span><span class="p">(),</span> <span class="n">fromLayer</span><span class="p">:</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="n">layer</span><span class="p">.</span><span class="n">speed</span> <span class="p">=</span> <span class="mf">0.0</span>
    <span class="n">layer</span><span class="p">.</span><span class="n">timeOffset</span> <span class="p">=</span> <span class="n">pausedTime</span>
<span class="p">}</span>
</pre></div>

        
    </article>    
         

		</main>
        
        
		<script type="text/javascript" src="./Recursion with Completion Handlers in Swift _ Built Light_files/builtlight.d41d8cd98f00.js"></script>

        
            
        
                
    
    

</body></html>